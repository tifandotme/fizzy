name: "Backup Infra Setup"
description: "Setup infrastructure for backup/restore: Tailscale, SSH, Kamal, GCS"

inputs:
  oauth-client-id:
    description: "Tailscale OAuth client ID"
    required: true
  oauth-secret:
    description: "Tailscale OAuth secret"
    required: true

runs:
  using: "composite"
  steps:
    - run: curl -sfS https://dotenvx.sh/install.sh | sh
      shell: bash

    - uses: tailscale/github-action@53acf823325fe9ca47f4cdaa951f90b4b0de5bb9 # v4.1.1
      with:
        oauth-client-id: ${{ inputs.oauth-client-id }}
        oauth-secret: ${{ inputs.oauth-secret }}
        tags: tag:ci
        version: latest
        ping: box.javanese-pound.ts.net

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan box.javanese-pound.ts.net >> ~/.ssh/known_hosts 2>/dev/null || true
        chmod 700 ~/.ssh
      shell: bash

    - uses: ruby/setup-ruby@675dd7ba1b06c8786a1480d89c384f5620a42647 # v1.281.0
      with:
        bundler-cache: true
    - run: gem install kamal --no-document
      shell: bash

    - name: Get Service Account Key
      id: secrets
      run: |
        JSON_KEY=$(dotenvx get BASE64_ENCODED_SERVICE_ACCOUNT_JSON | base64 -d)
        EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
        echo "credentials_json<<$EOF" >> "$GITHUB_OUTPUT"
        echo "$JSON_KEY" >> "$GITHUB_OUTPUT"
        echo "$EOF" >> "$GITHUB_OUTPUT"
      shell: bash

    - uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093 # v3.0.0
      with:
        credentials_json: "${{ steps.secrets.outputs.credentials_json }}"

    - uses: google-github-actions/setup-gcloud@aa5489c8933f4cc7a4f7d45035b3b1440c9c10db # v3.0.1
